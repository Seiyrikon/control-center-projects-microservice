<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- Mapper for tbl project   -->
<mapper namespace="com.example.microservice.dao.ProjectDao">


<!-- Gets all the info needed for project list -->
    <select id="projectList" resultType="com.example.microservice.model.ProjectList">
       SELECT tproj.proj_id,
              tproj.proj_name,
              tc.client_name,
              tproj.start_date,
              tproj.end_date, 
              devtype.dev_type_name,
              (SELECT COUNT(*) FROM tbl_user_project AS tup WHERE tup.proj_id = tproj.proj_id AND tup.emp_id != 100) AS members,
              ps.proj_status_name
         FROM tbl_project_mst AS tproj
              INNER JOIN tbl_proj_info AS tpi 
                  ON tproj.proj_id = tpi.proj_id
              LEFT JOIN tbl_clients_mst AS tc 
                  ON tpi.client_id = tc.client_id
              LEFT JOIN tbl_dev_type_mst AS devtype
                  ON tpi.dev_type_id = devtype.dev_type_id
              LEFT JOIN tbl_proj_status_mst AS ps
                  ON tpi.proj_status_id = ps.proj_status_id
        WHERE tproj.del_flag = 0
     ORDER BY tproj.proj_id DESC, tproj.reg_date DESC;
    </select>

     <!-- Select all members of a project -->
    <select id="getAllMembersOfProject" parameterType="java.lang.String" resultType="com.example.microservice.model.UserInfo">
        SELECT tup.emp_id,
               tpi.fname,
               tpi.lname,
               tposition.position_sh_name
          FROM tbl_project_mst AS tproj
            INNER JOIN tbl_user_project AS tup
                ON tproj.proj_id = tup.proj_id
            LEFT JOIN tbl_personal_info AS tpi
                ON tpi.emp_id = tup.emp_id
            LEFT JOIN tbl_user AS tuser
                ON tuser.emp_id = tup.emp_id
            LEFT JOIN tbl_position_mst AS tposition
                ON tposition.position_id = tuser.position_id
        WHERE tup.proj_id = #{proj_id} AND tup.del_flag = 0 AND tup.emp_id != 100;
        <!-- AND tup.emp_id != 100 -->
    </select>

    <select id="getProjectById" resultType="com.example.microservice.model.Project">
       SELECT proj_id, proj_name, proj_code, proj_description, start_date, end_date, del_flag
         FROM tbl_project_mst
        WHERE proj_id = #{proj_id};
    </select>

</mapper>